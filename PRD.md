# 通用敏感词管理 Symfony Bundle 功能性产品需求文档

## 功能目标

本项目旨在开发一个**通用的 Symfony Bundle 组件**，用于对文本内容进行敏感词过滤和管理。该组件将提供完整的敏感词库管理和文本检测功能，可灵活应用于评论审核、文章发布、即时消息过滤等场景。核心功能目标包括：

-   **敏感词库集中管理：** 提供后台界面方便维护敏感词列表。管理员可以通过 EasyAdmin 提供的界面对敏感词进行新增、编辑、删除、启用/禁用等操作，实现对敏感词库的集中管理[blog.csdn.net](https://blog.csdn.net/gitblog_00234/article/details/148548902#:~:text=1,%E5%AE%8C%E5%96%84%E7%9A%84%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B6%EF%BC%9A%E4%B8%8ESymfony%E5%AE%89%E5%85%A8%E7%B3%BB%E7%BB%9F%E6%97%A0%E7%BC%9D%E9%9B%86%E6%88%90)。敏感词支持分类标签（例如“政治类”“色情类”等）以便管理和筛选。
-   **多种匹配策略：** 系统支持多种敏感词匹配策略，以覆盖不同类型的敏感内容检测需求。包括精确匹配、模糊匹配（子串匹配）、正则表达式匹配，以及同义词/变体匹配（例如识别“法_轮_功”等变体写法）。
-   **灵活的处理机制：** 当检测到敏感词时，系统能够根据预先配置或调用时指定的策略采取不同的处理措施，包括：拒绝内容提交并给出提示、替换敏感词为占位符、将内容标记为待人工审核、以及记录日志或触发事件供外部系统使用。
-   **易集成的服务接口：** 提供可注入的服务（例如 `SensitiveWordChecker`），供应用中的其他服务或控制器调用进行敏感词检查。开发者可以通过该接口轻松将敏感词过滤嵌入到业务流程中，例如在评论提交时调用检查服务。
-   **高性能与可配置：** 考虑大规模敏感词库和高并发场景，组件将在实现上采用优化的数据结构或算法（如 Trie 树或 Aho-Corasick 多模匹配算法）提升检测效率[cloud.tencent.com](https://cloud.tencent.com/developer/news/1807253#:~:text=1)[cloud.tencent.com](https://cloud.tencent.com/developer/news/1807253#:~:text=%E6%80%A7%E8%83%BD%E5%92%8C%E5%A4%9A%E5%85%B3%E9%94%AE%E8%AF%8D%E5%8C%B9%E9%85%8D%EF%BC%9AAHOCorasick%20%E5%92%8C%20SensitiveWordFilter%20%E5%9F%BA%E4%BA%8E%20AC,%E8%87%AA%E5%8A%A8%E6%9C%BA%E5%92%8C%20DFA%20%E7%AE%97%E6%B3%95%EF%BC%8C%E9%80%82%E5%90%88%E9%9C%80%E8%A6%81%E9%AB%98%E6%80%A7%E8%83%BD%E5%A4%84%E7%90%86%E7%9A%84%E5%9C%BA%E6%99%AF%E3%80%82)。同时，通过配置文件设定全局策略，并允许在调用接口时动态指定处理策略，以满足不同场景下的差异化需求。

_（注：本功能范围不涉及多语言支持和复杂的权限控制，默认假定后台管理由授权管理员使用。）_

## 用户场景

为了更好地理解本组件的作用，下面列举典型的用户使用场景：

-   **场景1：评论发布审核** – 用户在网站上提交评论时，系统通过 `SensitiveWordChecker` 服务对评论内容进行敏感词扫描。如果包含敏感词且全局策略设置为“拒绝提交”，则评论不会被发布，接口返回错误提示信息（例如“您的评论包含敏感词，无法发布”）。管理员可以预先在后台敏感词库中配置需要拦截的词语及其类别，使评论区保持合规。
-   **场景2：论坛帖子内容过滤** – 用户发表论坛帖子，系统对帖子内容调用敏感词过滤服务。若检测到违规词汇且策略为“内容替换”，系统将自动用“\*\*\*”等占位符替换帖子中的敏感词，然后正常发布帖子。这种情况下用户的内容不会被拒绝，但敏感部分被屏蔽处理。
-   **场景3：消息系统实时过滤** – 在即时通信或弹幕系统中，用户发送消息前可先经过敏感词检查。若发现敏感词且策略设置为“标记待审核”，则该消息不会直接显示给所有人，而是标记为待审核状态，通知管理员进行人工审核。管理员在审核后台看到被标记的信息及触发的敏感词，高效决定后续处理（通过或删除）。
-   **场景4：敏感词库维护** – 内容安全管理员登录后台管理界面（由 EasyAdmin 提供）查看敏感词列表。管理员新添一个政治类敏感词“示例词汇”，选择匹配策略为“正则表达式”，设置为启用状态并归类到“政治”标签。保存后，系统立即将该新词缓存到内存的字典结构中。随后用户提交的内容将立即应用最新的敏感词规则进行过滤。
-   **场景5：外部系统联动** – 某合作审核系统需要获取敏感词命中事件以触发额外流程。管理员将组件全局响应策略设置为“触发事件”，并订阅了组件提供的敏感词检测事件。当有用户上传内容包含敏感词时，组件除了按照默认策略处理外，还会触发一个事件（或日志记录）[cloud.tencent.com](https://cloud.tencent.com/developer/article/1992042#:~:text=%E8%BF%99%E9%87%8C%E7%BB%99%E5%A4%A7%E5%AE%B6%E6%8E%A8%E8%8D%90%E4%B8%80%E4%B8%AA%E9%A1%B9%E7%9B%AE%EF%BC%8C%E5%9F%BA%E4%BA%8EAC%E8%87%AA%E5%8A%A8%E6%9C%BA%E7%9A%84%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%8F%E6%84%9F%E8%AF%8D%E5%8C%B9%E9%85%8D%EF%BC%9A)。外部系统监听到事件后，获取违规内容和词汇信息，进一步执行例如告警通知或统计分析。

以上场景展示了本组件在不同业务环境下的应用方式，既涵盖了前台用户交互（提交内容被过滤的体验），也涵盖了后台管理员维护和监控的过程。

## 功能模块设计

为实现上述功能目标，系统划分为几个主要功能模块：

### 3.1 敏感词库管理模块

此模块提供后台界面供管理员维护敏感词数据。基于 **EasyAdminBundle** 实现，可快速生成友好的CRUD管理界面[blog.csdn.net](https://blog.csdn.net/gitblog_00234/article/details/148548902#:~:text=1,%E5%AE%8C%E5%96%84%E7%9A%84%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B6%EF%BC%9A%E4%B8%8ESymfony%E5%AE%89%E5%85%A8%E7%B3%BB%E7%BB%9F%E6%97%A0%E7%BC%9D%E9%9B%86%E6%88%90)：
-   
- **敏感词列表展示：** 在后台管理面板中列出所有敏感词条目，包括词汇内容、所属分类标签、匹配策略类型、启用/禁用状态、创建/更新时间等信息。支持按照分类筛选和关键字搜索列表，方便管理员查找特定词条。
-   **新增敏感词：** 管理员可在后台添加新的敏感词条目。需要填写的字段包括：**词语/模式内容**（例如具体的敏感字词或正则表达式模式）、**分类标签**（从预定义类别中选择或输入，如“政治”“暴力”）、**匹配策略**（下拉选择精确/模糊/正则/同义变体匹配），以及**状态**（启用或禁用）。提交后新词将持久化到数据库，并更新缓存供检测模块使用。
-   **编辑/禁用词条：** 管理员可以对已有敏感词条进行编辑修改，例如调整分类、更改匹配策略，或暂时将其状态置为禁用。禁用的词条在检测时将被忽略。编辑界面会提供必要的表单校验（如正则表达式的格式校验），以确保输入合法。
-   **删除敏感词：** 支持管理员删除不需要的敏感词条。删除操作需有确认提示，避免误删。删除后相关词条应从数据库移除，并同步更新缓存，确保后续检测不再包含该词。
-   **批量操作（可选）：** 如果需要，后台界面可支持批量导入、导出敏感词列表以及批量启用/禁用操作。这对于初始建立大规模词库或将词库同步至其他系统会很有帮助。（此为扩展需求，可在后续版本考虑。）

_实现细节：采用 EasyAdminBundle 生成后台，通过配置敏感词实体即可自动生成常规的增删改查页面[blog.csdn.net](https://blog.csdn.net/gitblog_00234/article/details/148548902#:~:text=1,%E5%AE%8C%E5%96%84%E7%9A%84%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B6%EF%BC%9A%E4%B8%8ESymfony%E5%AE%89%E5%85%A8%E7%B3%BB%E7%BB%9F%E6%97%A0%E7%BC%9D%E9%9B%86%E6%88%90)。管理员界面应仅限内部管理员访问（通过Symfony自带的安全机制限制访问）；本组件不自行实现权限体系。每当敏感词数据有改动（新增/编辑/删除）时，应触发缓存更新或清除，以使检测服务使用最新数据。_

### 3.2 敏感词检测与匹配策略模块

此模块负责根据不同策略识别文本中的敏感内容，是过滤功能的核心。系统支持以下**四种敏感词匹配策略**，管理员在添加每个词条时可以指定该词条使用哪种匹配方式：

-   **精准匹配：** 文本中出现与敏感词库**完全一致**的词汇时触发。例如敏感词库包含“违禁品”，则输入文本中任何地方出现完整的“违禁品”即被视为命中。精确匹配一般要求被检测词语独立存在（对于英文可要求单词边界，对于中文则匹配连续字符）。该模式严格但误报率低，适用于需要明确拦截特定词语的场景。
-   **模糊匹配（子串匹配）：** 文本中出现包含敏感词字符的**子串**即可触发，无需完全匹配整个单词或短语。例如词库中有“违禁”，则“违禁品”或“出售违禁物”都会命中。模糊匹配适用于在单词或词组的一部分出现敏感内容也需过滤的情况，但可能扩大过滤范围，需要平衡误报。通常对英文可以不要求空格边界，即只要敏感词作为子串出现即可（如检测“sex”会命中“sextant”等）。
-   **正则表达式匹配：** 将敏感词条解释为正则表达式模式，对文本执行正则匹配。一旦正则匹配成功即视为包含敏感内容。此策略适用于那些很难用固定字符串表示的敏感内容规则。例如可以用正则定义一类变体词：“(法轮功|FLG|falungong)”来拦截多种拼写。管理员在后台输入正则表达式时需要遵循PHP兼容的正则语法。系统在检测时对标记为正则的词条使用相应的正则引擎进行匹配（可能性能相对较低，因此应谨慎使用较复杂的正则）。
-   **同义词/变体匹配：** 该策略用于捕获**经过变形或隐藏的敏感词**。例如有些敏感词用户为了逃避检测，会在字符中间插入符号或使用变体字：“法_轮_功”。启用此策略的词条允许定义通配符占位符（如“_”或其他约定符号）来代表任意字符，从而匹配“法任何字符轮任何字符功”形式的文本。这种匹配本质上是一种**模糊变形匹配**，可以通过在检测时忽略文本中某些无意义符号或使用算法匹配间隔字符来实现。当管理员在词库中以“法_轮\*功”形式录入时，系统将其转换为合适的模式（例如转换为正则`/法.*轮.*功/`）用于检测。此策略也可以涵盖**同义词**的概念，即如果某敏感词有多种写法或代称，可在模式中使用通配符或预先在词库录入多个等价词条来实现都命中。

为了实现高效的多模式匹配，系统在加载所有启用的敏感词后，会根据其策略类别采取不同的处理方式：

-   对于**精确**和**模糊**匹配的词条，可统一使用字符串匹配算法进行检测。由于可能存在大量词需要同时检查，推荐采用基于**Trie 树**或更优化的 **Aho-Corasick自动机算法** 构建多模式匹配机，以一次遍历高效找出文本中出现的所有敏感词[cloud.tencent.com](https://cloud.tencent.com/developer/news/1807253#:~:text=1)。Aho-Corasick 算法是一种经典的多模字符串搜索算法，能在**一次扫描**中同时匹配词库中的多个关键词，具备接近线性的检测效率，非常适合敏感词过滤这种需要高性能的场景[cloud.tencent.com](https://cloud.tencent.com/developer/news/1807253#:~:text=%E6%80%A7%E8%83%BD%E5%92%8C%E5%A4%9A%E5%85%B3%E9%94%AE%E8%AF%8D%E5%8C%B9%E9%85%8D%EF%BC%9AAHOCorasick%20%E5%92%8C%20SensitiveWordFilter%20%E5%9F%BA%E4%BA%8E%20AC,%E8%87%AA%E5%8A%A8%E6%9C%BA%E5%92%8C%20DFA%20%E7%AE%97%E6%B3%95%EF%BC%8C%E9%80%82%E5%90%88%E9%9C%80%E8%A6%81%E9%AB%98%E6%80%A7%E8%83%BD%E5%A4%84%E7%90%86%E7%9A%84%E5%9C%BA%E6%99%AF%E3%80%82)。
-   对于**正则表达式**策略的词条，由于无法用Trie直接处理，系统将在检测时针对每个正则模式单独进行匹配（或将多个模式编译组合）。为优化性能，可以预编译所有正则模式（使用PHP的`preg_compile`等机制）并缓存，以减少每次匹配的开销。正则匹配应注意设置合适的超时或回溯限制，防止个别恶意构造的正则影响整体性能。
-   对于**同义/变体匹配**策略的词条，其检测可以通过**输入标准化**和**通配模式匹配**相结合实现。一方面，在检测前可预处理文本，比如去除常见干扰符号、将全角字符转换为半角、统一大小写等，从而削弱用户变形的影响[cloud.tencent.com](https://cloud.tencent.com/developer/article/1992042#:~:text=%E8%BF%99%E9%87%8C%E7%BB%99%E5%A4%A7%E5%AE%B6%E6%8E%A8%E8%8D%90%E4%B8%80%E4%B8%AA%E9%A1%B9%E7%9B%AE%EF%BC%8C%E5%9F%BA%E4%BA%8EAC%E8%87%AA%E5%8A%A8%E6%9C%BA%E7%9A%84%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%8F%E6%84%9F%E8%AF%8D%E5%8C%B9%E9%85%8D%EF%BC%9A)。另一方面，将通配符模式转换为正则或在Trie树中扩展节点实现“跳过字符”的匹配逻辑。例如，对于“法_轮_功”，可在Trie中构建相应路径，允许在“法”与“轮”之间跳过若干非关键字符。这部分实现相对复杂，但通过合理设计，可以在保证一定准确度的前提下识别大多数此类变形敏感词。

_（注：ToolGood.Words 等开源项目中提供了对全角/半角字符转换、繁简转换、拼音替换等增强型模糊匹配功能[cloud.tencent.com](https://cloud.tencent.com/developer/article/1992042#:~:text=%E8%BF%99%E9%87%8C%E7%BB%99%E5%A4%A7%E5%AE%B6%E6%8E%A8%E8%8D%90%E4%B8%80%E4%B8%AA%E9%A1%B9%E7%9B%AE%EF%BC%8C%E5%9F%BA%E4%BA%8EAC%E8%87%AA%E5%8A%A8%E6%9C%BA%E7%9A%84%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%8F%E6%84%9F%E8%AF%8D%E5%8C%B9%E9%85%8D%EF%BC%9A)。本组件在初版中不直接涵盖繁体或拼音等多语言变体处理，但保留接口设计的扩展性，未来可考虑添加这些文本规范化处理，提高对复杂变体的检测能力。）_

### 3.3 响应处理策略模块

一旦**检测模块**在用户提交的文本中发现了敏感词，该如何处理取决于预先配置或调用时指定的**响应策略**。组件支持如下几种处理策略，可全局配置默认值，并允许在使用服务接口时临时指定：

-   **拒绝提交（拦截模式）：** **默认且最严格**的策略。当文本包含敏感词时，系统将阻止该内容的正常提交或发布。对于前端用户，这通常表现为提交动作被取消并收到一条错误提示消息，指出其内容不合规（提示可笼统告知存在敏感内容，或具体指出哪个词敏感，视安全策略决定）。在实现上，`SensitiveWordChecker` 服务可以抛出一个特定的异常或返回错误结果，调用方（如控制器）拿到结果后中断后续流程。该策略确保违规内容决不会进入系统下一环节，适用于严禁出现敏感词的场景。
-   **内容替换（遮蔽模式）：** 当文本中含有敏感词时，系统并不拒绝内容，而是对敏感部分进行遮蔽处理，然后允许内容提交通过。典型做法是将敏感词替换为固定占位符，例如用“_”字符串替换每个被禁词（如“这篇文章有敏感词”会被替换为“这篇文章有_\*\*”）。占位符长度可以与原词长度一致以标示被替换部分的长度，也可以统一用固定符号表示。替换完成后，过滤后的文本将继续流程，例如存储到数据库或展示给用户。这种模式下，前端用户的体验是内容成功发布，但敏感词部分被系统打码。实现上，`SensitiveWordChecker` 服务返回处理后的文本字符串，由调用方使用该返回值代替原始内容。
-   **标记待审核（审核模式）：** 采用此策略时，检测到敏感内容并不会拦截或修改用户提交，但系统会将该内容标记为“需要人工审核”状态。具体做法可以是在内容的数据记录中加一个标记字段（例如 `is_flagged = true`），使其不会直接对公众可见或不会进入正常发布流程，而是进入审核队列。之后由管理员或审核人员在后台审核列表中查看被标记的内容及匹配的敏感词，决定是否通过或删除。对于用户而言，可能会收到提示如“您的内容已提交，正在审核中，请稍后发布”。此模式适用于一些允许宽松发布但后台巡查的场景。实现细节上，`SensitiveWordChecker` 服务可返回一个状态标志，调用方据此将内容标记并存储，同时可能通知审核人员。
-   **记录日志/触发事件（记录模式）：** 在这种策略下，系统检测到敏感词后，不干预内容发布流程（既不拦截也不修改），而是将事件记录下来，供后台或外部系统处理。记录形式可以是应用日志文件中的一条警告日志，包含违规词和上下文，也可以是触发一个Symfony事件（例如 `SensitiveWordDetectedEvent`），由有需要的监听器来处理。这样外部系统可以订阅该事件做进一步处理（比如统计敏感词出现次数、给相关负责人发送警报等），而不影响前端用户体验。此策略适合对一些轻度违规或敏感内容仅做监控而不即时处理的情况。实现上，`SensitiveWordChecker` 服务在返回正常结果的同时执行日志记录或事件调度。开发者可以通过配置选择采用Monolog日志记录还是事件方式，或两者并用。

管理员可以在配置文件中设置上述哪一种处理策略为系统**默认**行为。例如设置默认使用“拒绝提交”以确保安全。但在具体调用过滤服务时，开发者也可根据场景需要**动态指定**策略覆盖默认值（详见下文接口约定部分）。例如某些后台流程可以调用检查服务时要求采用“标记待审核”而非全局默认的拦截，以便人工复核。

需要注意的是，多种策略也可以组合使用于不同类别的敏感词上（扩展考虑）。例如对于“政治类”敏感词采用拒绝，而“色情类”敏感词采用替换。这在当前版本中可由调用端逻辑结合词条分类标签自行实现（检测返回敏感词清单后，根据分类决定处理方式），PRD初版中不细化至按类别配置不同策略，但预留了这样的灵活性。

### 3.4 配置与全局策略模块

本模块负责组件的全局配置管理，包括检测和处理策略的默认设置以及一些优化参数配置。通过Symfony配置文件（如 `config/packages/sensitive_word.yaml`）来提供可调整的选项：

-   **全局检测配置：** 设定敏感词过滤的全局行为参数。例如：
    -   默认**响应处理策略**：可选值如 `reject`（拒绝）, `replace`（替换）, `flag`（待审核）, `log`（记录）。这决定了在调用过滤服务且未明确指定策略时，系统采用的处理模式。管理员可根据业务需要调整默认策略。
    -   **占位符符号**：当使用替换策略时，定义用于替换敏感词的占位字符，如 `"*"` 或其他符号。亦可配置是否按原词长度重复占位符等细节。
    -   **检测强度**：一些全局开关影响检测过程的严格程度。例如是否启用对全角/半角字符的统一处理、是否忽略英文大小写（默认应当忽略大小写以提高匹配命中率）、是否移除常见特殊符号再匹配等。这些选项可以提升变体匹配效果，但也会增加一定开销，管理员可权衡开启。
    -   **缓存与加载**：配置是否启用敏感词缓存、缓存刷新策略等。例如可以配置启动时是否自动加载敏感词库至内存；当词库发生变化时通过何种机制更新缓存（如每次更改后自动清缓存或定时重载）。
-   **类别标签配置**（如果需要）：预先定义敏感词的分类列表及含义，可在配置中列出允许的分类值。虽然系统允许自由标签，但统一的配置有助于前端录入的规范性。
-   **阈值参数**（可能的扩展）：针对更复杂的场景，可配置一些阈值，例如同一文本中敏感词出现次数的上限、触发某些策略的敏感词严重等级阈值等等（初版不涉及此类复杂逻辑，可作为预留选项）。


配置文件采用Symfony惯用的方式，可在不同环境（dev/prod）使用不同参数。例如在开发环境可以将默认策略设为替换以便测试内容流转，而生产环境设为严格拒绝。所有配置项都会在Bundle初始化时加载，`SensitiveWordChecker` 服务和后台管理模块会基于这些配置调整自身行为。

此外，组件设计允许**运行时覆盖**配置：也就是在调用服务接口时传入参数以覆盖全局默认策略（下一节详述）。配置模块需要确保全局配置和局部参数的衔接——通常局部指定优先于全局默认。比如全局配置默认拒绝，但某次调用指定了替换，则该调用按替换执行，不影响其他地方默认逻辑。

### 3.5 服务接口模块（SensitiveWordChecker 服务）

本组件以一个可注入服务类 `SensitiveWordChecker` 向外提供敏感词检查功能。其他业务代码（控制器、服务等）可以通过依赖注入获取此服务并调用其方法。**接口约定**如下：

-   服务的主要方法将提供对输入文本的敏感词扫描及处理功能，方法签名示例：

    php

    复制代码

    `public function checkText(string $text, ?string $strategy = null): SensitiveCheckResult`

    这里 `$text` 是待检测的文本，`$strategy` 是可选的处理策略参数（取值可为 `"reject"`, `"replace"`, `"flag"`, `"log"` 等）。如果 `$strategy` 为 `null` 或未传，则采用全局默认策略。

-   根据传入策略的不同，`checkText` 方法的返回结果 `SensitiveCheckResult` 将包含不同信息：

    -   **当策略为拒绝提交：** 如果发现敏感词，则结果对象可能包含 `isAllowed=false` 以及 `message` 提示信息（或方法直接抛出异常）。调用方据此应中断流程并将提示反馈给用户。如果未发现敏感词，则 `isAllowed=true`，内容可正常通过。

    -   **当策略为内容替换：** 方法将在结果中提供 `filteredText` 字段，包含将敏感词替换为占位符后的新文本字符串，以及 `foundWords` 列表列出哪些词被替换。如果没有敏感词，则 `filteredText`与原文相同且 `foundWords` 为空。调用方应使用返回的 `filteredText` 继续后续业务处理。

    -   **当策略为标记待审核：** 返回结果中可包含一个标记标志如 `needsReview=true` 以及 `foundWords` 列表。调用方收到此结果后，应将内容存储并标记其待审核状态（例如设置数据库字段）。另外可以在结果中提供一个建议的审核提示供后台查看。

    -   **当策略为日志记录：** 在这种模式下，`checkText` 可以简单返回原始文本或一个 `isAllowed=true` 的状态，同时**内部已经完成日志/事件记录**。为了统一接口，也可返回检测出的 `foundWords` 列表供调用方参考。调用方在此策略下一般无需特殊处理，按正常流程继续即可。

-   服务应提供一种简便方式获取**是否包含敏感词的布尔结果**。例如：

    php

    复制代码

    `public function containsSensitive(string $text): bool`

    返回文本是否命中任何敏感词。这方法相当于 `checkText` 的快捷模式（仅判断存在与否）。内部实现上，`containsSensitive` 可直接调用 `checkText`，指定策略为拒绝但捕获结果，不抛异常，仅返回true/false。

-   服务可能还提供**获取详细匹配信息**的方法。例如：

    php

    复制代码

    `public function findAllSensitiveWords(string $text): string[]`

    返回文本中所有命中的敏感词列表（去重或按出现顺序）。这对一些需要显示哪些词违规的管理流程有用。

-   **事件与日志：** 当检测到敏感词时，无论采取何种策略，服务内部都可以记录日志或触发事件。例如可以定义事件类 `SensitiveWordEvent`，其中包含属性：文本、命中的词列表、所用策略、时间戳等。当服务发现敏感词且配置允许时，调用 `eventDispatcher` 分发事件。外部系统（包括应用自身的其他bundle）可以订阅该事件实现自定义操作。日志方面，也可在每次检测后将概要信息写入特定日志文件或监控系统，用于日后审计。


服务接口的设计强调**易用性和灵活性**。开发者在典型使用时，只需注入 `SensitiveWordChecker`，调用诸如：

php

复制代码

`$result = $sensitiveChecker->checkText($content, 'replace');`

然后根据返回结果属性判断如何处理或直接取得过滤后的文本继续处理。接口文档将清晰说明各种策略下结果的结构和含义，确保开发者毫无歧义地加以利用。

此外，要确保服务是**线程安全/请求安全**的（Symfony的服务默认是容器单例，但每个请求环境隔离）。服务内部如使用缓存的敏感词数据结构，应考虑并发读写问题：典型做法是在更新敏感词库时重新生成数据结构并替换旧的引用，从而使正在执行检测的线程不受影响，而新请求自动使用新数据。

## 数据结构设计

本节描述组件涉及的主要数据结构，包括**数据库表结构**和**内存数据结构**两方面。

### 4.1 数据库表结构

敏感词条目将存储在关系型数据库（例如 MySQL）的一张表中，建议命名为 `sensitive_words`。每个词条记录表示一种敏感词或模式，包含如下字段：

-   **id** (INT, 主键，自增)：唯一标识每个敏感词条目。

-   **word** (VARCHAR/NVARCHAR)：存储敏感词的具体内容。对于不同匹配类型，该字段含义稍有不同：

    -   精确/模糊匹配词条：该字段即为需要匹配的字符串文本。例如“政治敏感词”。

    -   正则匹配词条：该字段存储正则表达式模式的字符串表示（无需起始和结束分隔符，在使用时程序会统一处理）。

    -   同义/变体匹配词条：可以使用特定符号表示通配的模式字符串，例如“法_轮_功”。存储时保留这些符号，匹配引擎会据此识别。

-   **category** (VARCHAR)：分类标签，描述该词条所属的类别或类型。例如“政治”, “色情”, “辱骂”等。可以为空或预设某些值。实现上可考虑独立一个 `categories` 表存储类别并与敏感词多对一关联，但初版也可简化为在同一表用字符串字段表示类别标签。

-   **match\_type** (ENUM 或 TINYINT)：表示匹配策略类型的代码。例如用枚举 `'exact'/'fuzzy'/'regex'/'variant'` 或存储为数字 1=精确,2=模糊,3=正则,4=变体。用于程序按不同类型采用不同处理逻辑。

-   **is\_active** (BOOLEAN)：标记该词条是否启用。为 `0` 时表示暂不参与过滤检查（相当于停用）。默认值为 `1`（启用）。

-   **created\_at** (DATETIME)：记录词条创建时间。

-   **updated\_at** (DATETIME)：记录最近一次修改时间。


根据业务需要，还可以扩展一些字段：

-   **severity\_level** (INT)：敏感级别或严重程度打分（可选，用于将来针对级别高的词采取更严厉措施）。

-   **creator** (VARCHAR)：记录是谁添加了该词条（如果需要审计）。

-   **replacement** (VARCHAR)：自定义替换内容（如果某些词希望替换为特定提示，如“和谐”），但一般不做如此复杂设计，统一用星号即可。


表需建立适当索引：

-   主键索引用于CRUD操作。

-   可在 `word` 字段上建立普通索引以辅助后台查询（例如后台搜索某关键词时的匹配）。不过由于可能需要模糊搜索，索引用处有限，必要时可采用全文索引或ElasticSearch来协助管理界面查询（属于扩展范畴）。

-   如按 `category` 筛选列表，可在 `category` 上建索引。

-   `is_active` 也可与其他字段组成组合索引用于查询启用状态的词条集合，但更多是程序启动时一次性加载全部启用词条，频繁查询相对较少。


关于**数据量规模**的考虑：一张敏感词表可能包含成百上千甚至上万条词条。需要确保数据库设计在该数量级下操作无瓶颈。读操作主要发生在初始化加载（或缓存失效重新加载）时，可以接受。写操作为管理员偶尔增删改，频率低但要求可靠。可以通过Migration工具创建上述表结构，并考虑在Bundle中提供基础的Repository或ORM实体。

### 4.2 内存数据结构

为了满足高性能的检查需求，组件会将敏感词库从数据库加载到内存，并构建高效的数据结构用于匹配：

-   **Trie字典树 / AC自动机结构：** 对于精确和模糊匹配的词条，采用Trie树将所有词构建成前缀共享的结构。每个节点存储一个字符及其子节点引用，并可能有“终止标记”指示至此构成了一个敏感词。还可以在Trie节点上存储失败指针（failure link），将多条模式融合成Aho-Corasick自动机，用于一次遍历文本就检测出所有词。[cloud.tencent.com](https://cloud.tencent.com/developer/article/1992042#:~:text=AC%E8%87%AA%E5%8A%A8%E6%9C%BA%E5%85%A8%E7%A7%B0%E6%98%AFAho)提到，通过在Trie基础上加入失效指针构建AC自动机，可极大提升多模式匹配效率。  
    初始化时，系统读取所有启用且匹配类型为精确/模糊的词条，将其插入Trie结构，然后预计算失败指针表，得到完整的AC自动机。检测时，对输入文本逐字符遍历，沿Trie状态迁移，利用失败指针高效跳转，一旦到达某节点标记为敏感词结尾，即记录命中。这样能够在O(N + M + 输出)的时间内完成匹配（N为文本长度，M为所有模式总长度）。

-   **正则模式集合：** 对于正则匹配类型的词条，系统将它们编译为PHP正则表达式对象（或者将模式字符串存入数组）。可以选择将多个正则合并成一个大型正则，但考虑可读性和隔离性，倾向逐条检测。正则集合可以缓存在服务实例中，以避免每次重新编译。检测文本时，遍历此正则集合，对每个执行一次 `preg_match` 检查是否存在匹配。如果正则数量不多（通常管理员不会大量使用复杂正则），这种方式可接受。如果数量庞大，则需要评估性能，或将正则转为Trie无法覆盖的部分另做优化（非本阶段重点）。

-   **变体匹配处理：** 对于带通配符的变体匹配词条，取决于实现策略：

    -   若采用转正则实现，则可以在加载时将这些模式（如包含“_”的）转换为对应正则表达式并归入正则集合处理。例如“法_轮\*功”转换为 `/法.{0,5}轮.{0,5}功/`（假设允许每处最多跳过5个字符）。具体跳过多少可在配置中设定一个合理上限，以平衡匹配灵活性与性能。

    -   若采用Trie扩展实现，则需要在Trie中为通配符引入特殊处理逻辑。比如预处理时将模式拆分为固定片段，在文本匹配时遇到通配符节点可以选择跳过若干字符再继续匹配下一个固定片段。这接近正则的后向查找功能，复杂度较高。鉴于实现难度，实际开发中更可行的是将此类模式作为正则处理或通过预清洗文本来实现（例如移除文本中无意义字符再做精确匹配）。

-   **缓存刷新机制：** 当敏感词表有更新（增删改）时，内存中的数据结构需要更新。简单方案是**每次**调用检测服务都从数据库拉取最新数据构建结构，显然在高频场景下开销过大。优化方案是在内存中做缓存：

    -   **启动加载**：应用启动或首次使用服务时，将所有启用的敏感词加载入内存并构建上述结构。此后对于每次检测请求直接使用内存数据，无需访问数据库。

    -   **实时更新**：在管理员通过后台修改词库后，可以有几种方式更新缓存：1）**事件触发**：在词条实体保存/删除操作后，发出缓存失效事件，由 `SensitiveWordChecker` 服务侦听并重建数据结构；2）**定时刷新**：设置定时任务每隔一定时间同步数据库更新；3）**懒加载刷新**：每次调用检测前检查上次更新时间与数据库最后更新时间比对，如果有新修改再重载。综合考虑推荐**事件触发**方式即时更新，以保证敏感词策略调整能立即生效，又不会给每次检测增加额外判断成本。

    -   **内存占用**：对于上万条量级的敏感词，Trie/AC结构占用的内存可能在数MB级别，具体取决于词的平均长度。需要评估PHP在目标环境下可用内存，确保缓存结构在可接受范围。如有必要，可考虑使用共享内存或本地文件存储Trie序列化后的结果，以在多进程复用（但Symfony应用一般是长驻内存，复用意义不大）。


简而言之，数据结构设计在存储层采用**规范化的关系表**方便管理和持久化，在应用层采用**高度优化的内存结构**确保检测速度。两者通过缓存机制关联，既保证了管理的便利，也满足了运行时的高效率。

## 非功能需求

除了上述功能性模块要求，本组件在非功能方面也需要满足一些关键指标：

-   **性能与效率：** 敏感词过滤对性能要求高，需要能够在**低延迟**下处理大量文本检查。采用Trie树/AC自动机算法正是为了提升多关键词匹配的效率[cloud.tencent.com](https://cloud.tencent.com/developer/news/1807253#:~:text=%E6%80%A7%E8%83%BD%E5%92%8C%E5%A4%9A%E5%85%B3%E9%94%AE%E8%AF%8D%E5%8C%B9%E9%85%8D%EF%BC%9AAHOCorasick%20%E5%92%8C%20SensitiveWordFilter%20%E5%9F%BA%E4%BA%8E%20AC,%E8%87%AA%E5%8A%A8%E6%9C%BA%E5%92%8C%20DFA%20%E7%AE%97%E6%B3%95%EF%BC%8C%E9%80%82%E5%90%88%E9%9C%80%E8%A6%81%E9%AB%98%E6%80%A7%E8%83%BD%E5%A4%84%E7%90%86%E7%9A%84%E5%9C%BA%E6%99%AF%E3%80%82)。预期性能目标是在1万条敏感词级别的词库、千字长度文本的情况下，单次检测应在毫秒级完成（理想状况AC自动机处理万字文本可低于1ms[cloud.tencent.com](https://cloud.tencent.com/developer/article/1992042#:~:text=Image)）。为了达成这一目标，需优化实现细节：

    -   尽量减少不必要的内存分配和复制，在遍历文本时使用高效的数据结构。

    -   合理使用PHP的字符串函数和正则函数，避免低效的逐字串比对（Trie已经避免了这一点）。

    -   对于长文本，可以在达到一定匹配结果后提前中止（例如策略为拒绝时，找到一个即可停止扫描，提高效率）。

    -   通过Profiling不断调整算法实现，确保在预期数据量下无明显瓶颈。

-   **可扩展性：** 组件设计需考虑未来扩展。例如：

    -   易于增加新的匹配策略（如日后引入基于机器学习的智能匹配作为一种策略，或基于词性分析的过滤等），要求代码结构清晰、模块解耦，新增策略时只需增加实现而不破坏现有代码。

    -   可支持更多语言或文本处理（虽然当前不做多语言，但设计数据库和代码时，多语言扩展不应被彻底封死，例如词表可以增加language字段将来支持不同语言的词库）。

    -   易于集成其他系统，比如将来可能需要将敏感词检测封装为REST API供非Symfony应用调用，那么在设计 `SensitiveWordChecker` 接口时就要考虑到返回结果可以序列化成API格式等。

-   **可靠性与健壮性：** 过滤系统对整体内容安全负责，必须稳健：

    -   **错误处理：** 对任何异常情况（如正则表达式错误、文本过长导致处理超时等）要有处理机制，不能因为过滤器故障导致内容审核通过或系统崩溃。可以对单次过滤设置超时上限，或捕获异常改为默认拒绝策略（宁可错杀不可放过，在安全方向上保证不出漏检）。

    -   **边界情况：** 需要测试并保证组件能处理各种极端输入，如非常长的连续字符串、包含特殊字符的文本、词库中有相似前缀的大量词（Trie需要正确处理前缀关系）、以及词库为空或文本为空等情况，均不会出错。

    -   **一致性：** 敏感词检测应**结果可预期**，同样的输入在相同配置下应始终得到相同的过滤结果，不能出现偶尔漏检的随机行为。为此核心算法应经过充分单元测试验证。

-   **用户体验：** 主要体现在管理端和被过滤内容提示上：

    -   后台EasyAdmin界面应简洁明了，字段说明清晰。对于正则或通配符这样的高级用法，界面上可提供说明或示例，避免管理员配置错误。

    -   前端用户收到的敏感词提示应尽量礼貌且不透露过多策略细节（避免恶意用户反推绕过方法）。这些提示内容可以配置国际化字典，但由于不涉及多语言，可在配置中简单设置中文提示语。

    -   替换模式下，应保证替换符号不影响文本可读性太多，只是将敏感部分模糊掉，例如常用星号等。

-   **安全性：** 尽管未实现复杂权限控制，但基本的安全要求需达标：

    -   管理后台路由应受权限保护，仅授权用户可访问。推荐使用Symfony自带的角色机制限制EasyAdmin的访问，例如仅ROLE\_ADMIN用户能进入敏感词管理菜单。组件本身提供菜单注册时应注明必要的角色。

    -   防范常见安全问题，如管理员在输入正则时可能输入恶意模式导致ReDoS（正则拒绝服务攻击），系统应对正则做复杂度评估或限制长度。

    -   对于事件触发模式，要注意敏感信息泄漏控制。例如日志中记录敏感词时，应存放在受限的日志文件或脱敏处理，以防止敏感词通过日志泄漏给无关人员。

-   **部署和维护：** 作为Symfony的Bundle组件，应符合Symfony扩展最佳实践：

    -   提供清晰的安装说明（composer安装Bundle，注册到Kernel或Bundles.php，导入路由配置等）。

    -   提供基础的配置示例文件，方便开发者引入并修改。

    -   编写必要的文档（README或开发文档）解释各部分功能和使用方法，尤其是接口的用法、事件机制等，降低接入门槛。

    -   在Bundle的代码仓库中包含自动化测试（单元测试）以验证核心逻辑正确性，并考虑与主应用的集成测试（可选）。

    -   易于升级和维护，如果以后词库字段需要调整（比如增加字段）或策略更新，通过数据库迁移和版本变更文档及时说明，保证向后兼容或提供平滑的数据迁移方案。


综上，本PRD不仅要求实现预定的敏感词过滤功能，还要求在性能、可靠性和可扩展性上达到企业级应用的标准。通过合理的架构设计和严格的测试验证，确保该 Symfony Bundle 可以稳健地应用在实际生产环境中，持续为内容安全保驾护航。[cloud.tencent.com](https://cloud.tencent.com/developer/news/1807253#:~:text=1)[cloud.tencent.com](https://cloud.tencent.com/developer/news/1807253#:~:text=%E6%80%A7%E8%83%BD%E5%92%8C%E5%A4%9A%E5%85%B3%E9%94%AE%E8%AF%8D%E5%8C%B9%E9%85%8D%EF%BC%9AAHOCorasick%20%E5%92%8C%20SensitiveWordFilter%20%E5%9F%BA%E4%BA%8E%20AC,%E8%87%AA%E5%8A%A8%E6%9C%BA%E5%92%8C%20DFA%20%E7%AE%97%E6%B3%95%EF%BC%8C%E9%80%82%E5%90%88%E9%9C%80%E8%A6%81%E9%AB%98%E6%80%A7%E8%83%BD%E5%A4%84%E7%90%86%E7%9A%84%E5%9C%BA%E6%99%AF%E3%80%82)

**参考资料：** 本组件设计综合了业界常用的多模式匹配算法以及Symfony最佳实践。例如Aho-Corasick算法因**高效多关键词匹配**而被广泛用于敏感词过滤[cloud.tencent.com](https://cloud.tencent.com/developer/news/1807253#:~:text=1)。我们借鉴了这些理念，并充分利用了Symfony的EasyAdmin后管能力[blog.csdn.net](https://blog.csdn.net/gitblog_00234/article/details/148548902#:~:text=1,%E5%AE%8C%E5%96%84%E7%9A%84%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B6%EF%BC%9A%E4%B8%8ESymfony%E5%AE%89%E5%85%A8%E7%B3%BB%E7%BB%9F%E6%97%A0%E7%BC%9D%E9%9B%86%E6%88%90)来快速构建管理界面。此外，还参考了开源项目对变体检测的处理（如ToolGood.Words对全/半角和模糊搜索的支持[cloud.tencent.com](https://cloud.tencent.com/developer/article/1992042#:~:text=%E8%BF%99%E9%87%8C%E7%BB%99%E5%A4%A7%E5%AE%B6%E6%8E%A8%E8%8D%90%E4%B8%80%E4%B8%AA%E9%A1%B9%E7%9B%AE%EF%BC%8C%E5%9F%BA%E4%BA%8EAC%E8%87%AA%E5%8A%A8%E6%9C%BA%E7%9A%84%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%8F%E6%84%9F%E8%AF%8D%E5%8C%B9%E9%85%8D%EF%BC%9A)），以指导本组件在未来版本的优化方向。以上策略和设计确保本组件功能完善、性能卓越且易于使用。

